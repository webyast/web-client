<!--
# Copyright (c) 2009-2010 Novell, Inc.
# 
# All Rights Reserved.
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of version 2 of the GNU General Public License
# as published by the Free Software Foundation.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, contact Novell, Inc.
# 
# To contact Novell about this file by physical or electronic mail,
# you may find current contact information at www.novell.com
-->
<%# Sort by priority then by name %>
<% @repos.sort! {|x,y| x.priority == y.priority ? x.name.upcase <=> y.name.upcase : x.priority <=> y.priority} -%>

<% content_for :head do %>
  <% if JSMIN == false %>
    <%= javascript_include_tag "jquery.quicksearch.js"-%>
  <% end %>
 
  <%= javascript_include_tag :defaults %>

  <style type="text/css">
    label.error { float: none; color: red; padding-left: 6.5em; vertical-align: top; width: 70%; text-align: left }
  </style>

  <script type="text/javascript">
    $(document).ready(function(){
      // define a custom validation function for repository URL
      jQuery.validator.addMethod("repo_url", function(value, element) {
	return this.optional(element)
	// modified regexp from jQuery validation: accept any protocol, not only http(s) and ftp
	|| /^([a-zA-Z]+):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(value);

      }, "<%= _("Enter a valid repository URL.") -%>");

      // define a custom validation function for repository alias
      jQuery.validator.addMethod("repo_alias", function(value, element) {
	return this.optional(element)
	// PackageKit does not accept some special characters in alias
	|| /^[^`'"\\\[\]^$\{\}<>]*$/i.test(value);

      }, "<%= _("Symbols <b>%s</b> are not allowed in repository alias.") % "^${}[]&gt;&lt;`\\'\\\"\\\\" -%>");

      // set custom translatable messages
      $.extend($.validator.messages, {
	required: "<%= _("This value cannot be empty.") -%>"
      });

      $(".accordion").accordion({
	 autoHeight : false,
	 navigation : true,
	 collapsible: true,
	 header     : 'div.list-fieldset div.list-fieldset-header',
     animated : false
      });

      $(".accordion").accordion('activate', false);

     <%# if show filter is present then simulate click on the header %>
     <%# to unfold the repository content %>
     <% if !@show.blank? && @repos.find{|x| x.id == @show} %>
       $('#repo_header_<%= safe_id(@show) -%>').click();
     <% end %>

      $('input#repo_search').quicksearch('#repositories div.list-fieldset', {
	  selector: 'span.quicksearch_content',
	  delay: 100
      });
    });


    // disable all submit buttons after submitting a form
    // avoid double submit by accident
    function disable_forms() {
      // disable submit buttons
      $(':submit').attr('disabled', 'disabled');
      // make all input elements (text fields...) read only
      $(':input').attr('readonly', 'readonly');
      // disable all delete buttons
      $('a.button').attr('onclick','return false;');
      $('a.button').attr('href','');
      $('a.button').attr('disabled', 'disabled');
    };

    // onsubmit handler
    function form_handler(sid) {
      if ($('#repositoryForm_' + sid).valid())
      {
	disable_forms();
	$('#progress_' + sid).show();
	return true;
      }
      else
      {
	return false;
      }
    }

    // onclick handler for "delete" link parent
    function delete_handler(elem, progress)
    {
      // if there are two childrens then the delete was confirmed
      // (rails create a dynanic form there)
      if (elem.childNodes.length == 2)
      {
	elem.onclick="";
	elem.childNodes[0].onclick="return false;";
	elem.childNodes[0].href="";
	disable_forms();
	$(progress).show();
      }
    }

    // handler for the filter element
    function select_repositories (val) {
      if (val == "all") {
	  $("#repositories > div.list-fieldset").show();
      }
      else if (val == "enabled") {
	$("#repositories > div.list-fieldset.repository-enabled").show();
	$("#repositories > div.list-fieldset.repository-disabled").hide();
      }
      else if (val == "disabled") {
	$("#repositories > div.list-fieldset.repository-enabled").hide();
	$("#repositories > div.list-fieldset.repository-disabled").show();
      };
     };

    function switch_flag(link, field, deflt, changes) {
      // change the hidden field and the link text
      if ($(field).val() == "true")
      {
	$(field).val("false");
	$(link).text("<%= _("enable") -%>");
      }
      else
      {
	$(field).val("true");
	$(link).text("<%= _("disable") -%>");
      };

      // display/hide the changes text
      if (deflt == $(field).val())
      {
	$(changes).hide();
      }
      else
      {
	$(changes).show();
      };
    };
  </script>
<% end %>

  <div class='plugin-icon'><img src='/icons/yast-online_update.png'/><%=_("Software Repositories") %></div>
  <div class='plugin-content'>
    <div class="loading"></div>
    <% disabled = !@permissions[:write] %>

    <h3 style="margin-left:12px;"><%=_("Configured software repositories") %></h3>

    <div id="softwarebar">
      <div id="home-container">
	<div id="home">		
	  <%=link_to image_tag("home.png", :id=>"home_image"), :controller=>"controlpanel", :action => :index %>
	</div>
      </div>
      <span style="clear:both; overflow:hidden;"></span>
      <div id="search-container">
	<form action="#" id="quicksearch">
	   <label><%= _("Quick Search") %></label>
	   <input type="text" id="repo_search">
	</form>
      </div>
      <span style="clear:both; overflow:hidden;"></span>
      <div id="link-container">
	  <% if !disabled %>
	    <div id="action_links" class="action_links">	
	      <%=link_to image_tag("/icons/yast-online_update.png", :class=>"icons") +  (_("Add New Repository") ), {:action => 'add'}, :onclick=>"$('#progress').show()" %>
	    </div>
	  <% end %>
      </div>
      <div id="filter-container">
	<label for="filter">
	  <%=  _("Filter repositories") %>
	  <%=image_tag("/images/filter.png", :style=>"vertical-align:text-top; margin-top:2px; margin-right:3px;width:16px; height:14px;")%>
	</label>
	<%= select_tag "filter", options_for_select([
	  [ _("All"), "all"],
	  [ _("Enabled"), "enabled"],
	  [ _("Disabled"), "disabled"]
	])
	%>
	<%= observe_field("filter", :function => "select_repositories(value)") %>
      </div>
    </div>
    <div style="clear:both; overflow:hidden;"></div>

    <div id="repositories" class="accordion">
      <% @repos.each do |r| %>
	<% sid = safe_id(r.id) %>
	<div class="list-fieldset  <%= r.enabled ? 'repository-enabled' : 'repository-disabled' %>">
	  <div class="list-fieldset-header" id="repo_header_<%= sid -%>">
	    <%# do quick search only in name and URL => use quicksearch_content class %>
	    <span class="quicksearch_content">
	      <div>
		<div class="status-icon <%= r.enabled ? 'ok' : 'unused' %>"></div>
		<%= h r.name %>
	      </div>
	      <small><%= h r.url %></small>
	    </span>
	    <span style="float: right; margin-right: 5em"><%= prio_summary r.priority -%></span>
	  </div>
	  <div class='repository-content' style="display:none">
	      <% form_for(:repository, r, :url => { :action => 'update', :id => r.id },
		:html => { :method => :put, :id => 'repositoryForm_' + sid, :onsubmit => "form_handler('#{sid}')" }
	      ) do |f| %>

		<% content_for :head do %>
		  <script type="text/javascript">
		      $(document).ready(function(){
			// validate the form
			$("#repositoryForm_<%= sid -%>").validate()
		      });
		  </script>
		<% end %>

		<p><div style="min-width: 6em; float: left; margin-left: 1em">Alias: </div><i><%= h r.id %></i></p>

		<p><div style="min-width: 6em; float: left; margin-left: 1em">Name: </div>
		  <%= f.text_field :name, :disabled => disabled, :class => 'required' -%></p>

		<p><div style="min-width: 6em; float: left; margin-left: 1em">URL: </div>
		  <%= f.text_field :url, :disabled => disabled, :class => 'repo_url required' -%></p>

		<p><%= _("Repository is currently") %> <i><%= bool_status r.enabled %></i>.
		  <% if !disabled  %>
		    <%= hidden_field_with_link f, sid, :enabled, r.enabled,
		      _("Repository will be %s.") % bool_status(!r.enabled, {}) -%>
		  <% end %>
		</p>

		<p><%= _("Autorefresh is currently") %> <i><%= bool_status r.autorefresh %></i>.
		  <% if !disabled  %>
		    <%= hidden_field_with_link f, sid, :autorefresh, r.autorefresh,
		      _("Autorefresh will be %s.") % bool_status(!r.autorefresh, {}) -%>
		  <% end %>
		</p>

		<p><%= _("Keeping downloaded packages is currently") %> <i><%= bool_status r.keep_packages %>.</i>
		  <% if !disabled  %>
		    <%= hidden_field_with_link f, sid, :keep_packages, r.keep_packages,
		      _("Keep packages option will be %s.") % bool_status(!r.keep_packages, {}) -%>
		  <% end %>
		</p>

		<div class="nav-buttons">
		  <% if !disabled -%>
		  <div id="progress_<%= sid -%>" style="display: none; margin-bottom: 10px"><img src="/images/working.gif" alt="Working"/><span style="vertical-align: 50%; margin-left: 5px">...Wait...</span></div>
		    <%= submit_tag _("Save") %>
		    <span onclick="delete_handler(this, '#progress_<%= sid -%>');"><%= link_to _("Delete"),
			    {:action => 'delete', :id => r.id},
			    {:confirm => _("Really delete repository '%s'?") % h(r.name), :method => :delete, :class => :button} %></span>
		  <% end -%>
		</div>

	      <% end %>
	  </div>
	</div>
      <% end %>
    </div>

    <div class="nav-buttons">
      <%= form_back_button %>
    </div>
  </div>
