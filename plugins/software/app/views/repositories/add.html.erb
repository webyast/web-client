<% content_for :head do %>
  <%= javascript_include_tag :defaults %>

  <style type="text/css">
    label.error { float: none; color: red; padding-left: .5em; vertical-align: top; width: 100%; text-align: left }
  </style>

  <script type="text/javascript">
     $(document).ready(function(){
	// define a custom validation function for repository URL
	jQuery.validator.addMethod("repo_url", function(value, element) {
	  return this.optional(element)
	  // modified regexp from jQuery validation: accept any protocol, not only http(s) and ftp
	  || /^([a-zA-Z]+):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(value);

	}, "<%= _("Enter a valid repository URL.") -%>");

	// define a custom validation function for repository alias
	jQuery.validator.addMethod("repo_alias", function(value, element) {
	  return this.optional(element)
	  // PackageKit does not accept some special characters in alias
	  || /^[^`'"\\\[\]^$\{\}<>]*$/i.test(value);

	}, "<%= _("Symbols <b>%s</b> are not allowed in repository alias.") % "^${}[]&gt;&lt;`\\'\\\"\\\\" -%>");

        // validate the form
	$("#repositoryForm").validate()

	// set custom translatable messages
	$.extend($.validator.messages, {
	  required: "<%= _("This value cannot be empty.") -%>"
	});
     });

    // toggle the enable/disable link text after clicking it
    // and update the hidden field
    function toggle_flag(link, field, enabled_text, disabled_text) {
      // change the hidden field, link text and hide/show the status
      if ($(field).val() == "true")
      {
	$(field).val("false");
	$(link).text("<%= _("enable") -%>");
	$(enabled_text).hide();
	$(disabled_text).show();
      }
      else
      {
	$(field).val("true");
	$(link).text("<%= _("disable") -%>");
	$(enabled_text).show();
	$(disabled_text).hide();
      };
    };

    // update the icon if enabled status is changed
    function update_icon() {
      if ($('#repo_enabled').val() == 'true')
      {
	$('#status_icon').removeClass('unused').addClass('ok');
      }
      else
      {
	$('#status_icon').removeClass('ok').addClass('unused');
      }
    };

  </script>
<% end %>


<% disabled = ! @permissions[:write] %>
<div class='plugin-icon'><img src='/icons/yast-online_update.png'/>
  <%= _("Software Repositories") %>
  <%= header_spacer %>
  <%= _("Add a new repository") %>
</div>

<div class='plugin-content grid_12'>

<% form_for(:repository, @repo, :url => { :action => 'create', :id => @repo.id }, :html => { :method => :post, :id => 'repositoryForm',
    :onsubmit => "if ($('#repositoryForm').valid()) {$('#progress').show(); return true;} else return false;" } ) do |f| %>
  <fieldset class="wrapper with-background">
    <div id="status_icon" class="status-icon <%= @repo.enabled ? 'ok' : 'unused' %>"></div>
    <span style="padding-bottom: 8px; vertical-align: 50%; font-weight: bold"><%= _("New Repository") %></span>

    <p><div style="min-width: 6em; float: left;">Alias: </div>
    <%= f.text_field :id, :disabled => disabled, :class => 'repo_alias required' -%></p>

    <p><div style="min-width: 6em; float: left;">Name: </div>
    <%= f.text_field :name, :disabled => disabled, :class => 'required' -%></p>

    <p><div style="min-width: 6em; float: left;">URL: </div>
    <%= f.text_field :url, :disabled => disabled, :class => 'repo_url required' -%></p>

    <p onclick="update_icon();"><%= hidden_field_with_toggle_link f, :enabled, @repo.enabled,
	_("Repository will be %s.") % "<i>#{bool_status(true)}</i>",
	_("Repository will be %s.") % "<i>#{bool_status(false)}</i>" -%>
    </p>

    <p><%= hidden_field_with_toggle_link f, :autorefresh, @repo.autorefresh,
	_("Autorefresh will be %s.")% "<i>#{bool_status(true)}</i>",
	_("Autorefresh will be %s.")% "<i>#{bool_status(false)}</i>" -%>
    </p>

    <p><%= _("Priority for packages:") %> <%= prio_selector f, @repo.priority, disabled %></p>

    <p><%= hidden_field_with_toggle_link f, :keep_packages, @repo.keep_packages,
	_("Keep packages option will be %s.")% "<i>#{bool_status(true)}</i>",
	_("Keep packages option will be %s.")% "<i>#{bool_status(false)}</i>" -%>
    </p>
  </fieldset>

  <fieldset>
    <%= form_back_button :action => :index, :onclick=>"$('#progress').show()"%>
    <% if !disabled -%>
      <%= form_str_spacer %>
      <%= form_next_button :label => _("Save") %>
    <% end -%>
  </fieldset>
<% end %>
</div>
