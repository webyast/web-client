<% content_for :head do %>
  <%= javascript_include_tag :defaults %>

  <style type="text/css">
    label.error { float: none; color: red; padding-left: .5em; vertical-align: top; width: 100%; text-align: left }
  </style>

  <script type="text/javascript">
     $(document).ready(function(){
	// define a custom validation function for repository URL
	jQuery.validator.addMethod("repo_url", function(value, element) {
	  return this.optional(element)
	  // modified regexp from jQuery validation: accept any protocol, not only http(s) and ftp
	  || /^([a-zA-Z]+):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(value);

	}, "<%= _("Enter a valid repository URL.") -%>");

	// define a custom validation function for repository alias
	jQuery.validator.addMethod("repo_alias", function(value, element) {
	  return this.optional(element)
	  // PackageKit does not accept some special characters in alias
	  || /^[^`'"\\\[\]^$\{\}<>]*$/i.test(value);

	}, "<%= _("Symbols <b>^${}[]&gt;&lt;`\\'\\\"\\\\</b> are not allowed in repository alias.") -%>");

        // validate the form
	$("#repositoryForm").validate()

	// set custom translatable messages
	$.extend($.validator.messages, {
	  digits: "<%= _("Enter a number in range 0 (the highest priority) to 200 (the lowest priority).") -%>",
	  min: "<%= _("Priority must be a positive number.") -%>",
	  max: "<%= _("Priority must be less than 200.") -%>",
	  required: "<%= _("This value cannot be empty.") -%>"
	});
     });


  </script>
<% end %>


<% disabled = ! @permissions[:write] %>

<% if @adding -%>
  <h3><%= _("Add a new repository") -%></h3>
<% else %>
  <h3><%= disabled ? _("Repository Properties") : _("Edit Repository Properties") -%></h3>
<% end -%>

<br/>

<% form_for(:repository, @repo, :url => { :action => (@adding ? 'create' : 'update'), :id => @repo.id }, :html => { :method => (@adding ? :post : :put), :id => 'repositoryForm', :onsubmit => "if ($('#repositoryForm').valid()) {$('#progress').show(); return true;} else return false;" } ) do |f| %>
  <%= f.error_messages %>

  <div class="table">
    <table class="list" cellpadding="3" cellspacing="0">
    <tr>
 	<th class="full" colspan="2"><%=_("Repository")%></th>
    </tr>

    <tr>
	<td class="first" width="120"><strong><%=_("Alias")-%></strong></td>
	<% if @adding -%>
	  <td class="last"><%= f.text_field :id, :disabled => disabled, :class => 'repo_alias required' -%></td>
	<% else -%>
	  <td class="last"><strong><%= h @repo.id -%></strong></td>
	<% end -%>
    </tr>

    <tr>
	<td class="first" width="120"><strong><%=_("Enabled")-%></strong></td>
	<td class="last"><%= f.check_box :enabled, :disabled => disabled -%></td>
    </tr>

    <tr>
	<td class="first" width="120"><strong><%=_("Autorefresh")-%></strong></td>
	<td class="last"><%= f.check_box :autorefresh, :disabled => disabled -%></td>
    </tr>

    <tr>
	<td class="first" width="120"><strong><%= _("Name") -%></strong></td>
	<td class="last"><%= f.text_field :name, :disabled => disabled, :class => 'required' -%></td>
    </tr>

    <tr>
	<td class="first" width="120"><strong><%= _("URL") -%></strong></td>
	<td class="last"><%= f.text_field :url, :disabled => disabled, :class => 'repo_url required' -%></td>
    </tr>

    <tr>
	<td class="first" width="120"><strong><%=_("Priority")-%></strong></td>
	<td class="last"><%= f.text_field :priority, :disabled => disabled, :min => 0, :max => 200, :class => 'digits' -%></td>
    </tr>

    <tr>
	<td class="first" width="120"><strong><%=_("Keep downloaded packages")-%></strong></td>
	<td class="last"><%= f.check_box :keep_packages, :disabled => disabled -%></td>
    </tr>

    </table>

    <br/>
    <p>
      <% if !disabled -%>
	<%= f.submit @adding ? _("Create") : _("Update") %>
      <% end -%>

      <%= link_to _('Back'), {:action => :index}, :onclick=>"$('#progress').show()", :class => "button"-%>
    </p>
  </div>
<% end %>
