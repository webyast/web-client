<!--
# Copyright (c) 2009-2010 Novell, Inc.
# 
# All Rights Reserved.
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of version 2 of the GNU General Public License
# as published by the Free Software Foundation.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, contact Novell, Inc.
# 
# To contact Novell about this file by physical or electronic mail,
# you may find current contact information at www.novell.com
-->

<% content_for :head do %>

<%= javascript_include_tag "jquery.quicksearch.js"-%>
<%= javascript_include_tag "digitalspaghetti.password.js" %>
<%= javascript_include_tag "select_dialog.js" %>
<%= javascript_include_tag "users.js" %>

<!-- if no groups, disable validation
-->
<% if @permissions[:groupsget] != true %>
<script language="javascript">
function groups_validation(which){ return true; }
function def_group_validation(which){ return true; }
</script>
<% end %>       

 <style type="text/css">
    .pad1_2em {
	padding: 1em 2em;
    }
    tr {
	border: solid 1px #ddd;
    }
    label, .qs_input {
	width: auto !important;
    }
    .label {
        min-width: 10em;
        float: left;
        margin-left: 1em
    }
    #password-strength {
	left: 0em;
    }
 </style>

 <% javascript_tag do %>
 jQuery.expr[':'].Contains = function(a, i, m) {
  return jQuery(a).text().toUpperCase().indexOf(m[3].toUpperCase()) >= 0;
 };

  function select_groups_dialog() {
    var open_dialog = select_many_dialog({
      kind : 'groups',
      title : '<%= _('Select Groups') %>',
      selected_title : '<%= _('Selected Groups') %>',
      unselected_title : '<%= _('Available Groups') %>',
      tooltip : '<%= _('Click group names to select/unselect groups') %>',
      loadItems : function (dialogId) { 
        return $('#form_'+dialogId+' .grp-string')[0].value.split(",")
      },
      storeItems : function (dialogId, items) { 
        $('#form_'+dialogId+' .grp-string')[0].value = items.join(",");
      },
      allItems : function (dialogId) { 
        return $('#all_grps_string')[0].value.split(",") 
      }
    });
    return open_dialog;
  };
  
  function select_default_group_dialog() {
    var open_dialog = select_one_dialog({
      kind : 'group',
      title : '<%= _('Select Default Group') %>',
      tooltip : '<%= _('Click a group name to choose users default group') %>',
      allItems : function (dialogId) {
        return $('#all_grps_string')[0].value.split(",")
      },
      storeItem : function (dialogId, item) {
        $('#form_'+dialogId+' .groupname')[0].value = item;
      }
    });
    return open_dialog;
  };

  $(document).ready(function(){

    select_groups_open = select_groups_dialog();

    select_default_group_open = select_default_group_dialog();

// make the error message translatable - override the default messsage
   $.extend($.validator.messages, {
     equalTo:  "<%= _(" The passwords do not match.") -%>",
     required: "<%= _("This field is required.") -%>"
   });

 for(var i=0;i<$('.edit_user').length;i++){
  var id=$('.edit_user')[i].id;
   $("#"+id).validate()

   $("#"+id).validate({
    rules: {
      user_password: "required",
      user_password2: {
        equalTo: "#user_password"
      }
    }
   });

   $("#"+id+" .user-password").pstrength({
      'displayMinChar'      : true,
      'minCharText'      : "<%= _("Password Strength:") %>", 
      'verdicts'      : [
            "<%= _("Weak") %>",
            "<%= _("Normal") %>",
            "<%= _("Medium") %>",
            "<%= _("Strong") %>",
            "<%= _("Very Strong") %>"
          ]
      });
 }

      $(".accordion").accordion({
         autoHeight : false,
         navigation : true,
         collapsible: true,
         header     : 'div.list-fieldset div.list-fieldset-header',
         animated   : false
      });

      $(".accordion").accordion('activate', false);

  $('input#users_search').quicksearch('div.list-fieldset', {
          selector: 'span.quicksearch_content',
          delay: 100
  });


});//document.ready

<% end %>

<% end %>
<div class='plugin-icon'><img alt="yast-users" src='/icons/yast-users.png'/><%=_("Users")%></div>
<div class="plugin-content">

<form action="#" id="quicksearch" class="pad1_2em">
  <label><%= _("Filter:") %></label>
  <input type="text" id="users_search"/>
</form>

<div class='pad1_2em'>
<% if @permissions[:useradd] %>
<%= link_to _("Add New User"), :action => :new -%>
<% end %>

 <div id="users" class="accordion">
 <% disabled = ! @permissions[:usermodify] %>
  <% for user in @users %>
   <div class="list-fieldset">

    <div class="list-fieldset-header">
     <span class="quicksearch_content">
      <%= h user.uid -%> (<%= h user.cn || "-none-" -%>)
     </span>
    </div>

    <div class='user-content' style="display:none">
     <% form_for(user, :url => { :action => "update" }, :html => { :method => :put, :id => "form_"+user.uid, :onsubmit => "form_handler('#{user.uid}')", :autocomplete => :off } ) do |f| %>
      <%= f.error_messages %>

<%= render :partial => "user_edit", :locals =>{ :f => f, :disabled => disabled, :user => user, :new => false } %>

     <div class="nav-buttons">
    <div id="progress_<%= user.uid -%>" style="display: none; margin-bottom: 10px"><img src="/images/working.gif" alt="Working"/><span style="vertical-align: 50%; margin-left: 5px">...Wait...</span></div>
       <%= submit_tag _("Save"), :onclick=>"return edit_user_validation(this, '"+user.uid+"');"  %>
       <% if @permissions[:userdelete] %>
         <span onclick="delete_handler(this, '#progress_<%= user.uid -%>');">
           <%= link_to _("Delete"),
                       {:action => 'destroy', :id => user.uid},
                       {:confirm => _("Are you sure to delete user '%s'?") % user.uid, :method => :destroy, :class => :button} %>
         </span>
       <% end %>
     </div>
<script language="javascript">
   addTabsNavigation(".tabs_<%= user.uid %>", "span");
   $(".tabs_<%= user.uid %>").tabs();
</script>

    <% end %>
    </div> 
   </div>
  <% end %>
 </div>


  <div class="nav-buttons">
    <%= form_back_button -%>
    <%= form_str_spacer %>
    <%= link_to _("Manage Groups"), "controller" => "groups" %>
  </div>
</div>
            <div><input type="hidden" id="all_grps_string" value="<%= @all_grps_string %>" /></div>
</div>

