<% content_for :head do %>
  <%= javascript_include_tag :defaults %>

  <style type="text/css">
    label.error { float: none; color: red; padding-left: .5em; vertical-align: top; }
  </style>


	  <script type="text/javascript" src="/javascripts/jquery.example.js"></script>

	  <script type="text/javascript">
	    $(function() {
	      $('#mail_settings_smtp_server').example('SMTP server adress');
	    });
	  </script>

	  <script type="text/javascript">
	    $(function() {
	      $('#mail_settings_user').example('User name for SMTP server login');
	    });
	  </script>

	<script language="javascript">
	 function changeBox()
	 {
	    document.getElementById('div1').style.display='none';
	    document.getElementById('div2').style.display='';
	    document.getElementById('password').focus();
	 }
	 function restoreBox()
	 {
	    if(document.getElementById('password').value=='')
	    {
	      document.getElementById('div1').style.display='';
	      document.getElementById('div2').style.display='none';
	    }
	 }
	</script>


<script type="text/javascript">
    // define custom validation function for SMTP server validation
    jQuery.validator.addMethod("smtp_server", function(value, element) {
      return this.optional(element)
        // FQDN: http://regexlib.com/REDetails.aspx?regexp_id=391
        || /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}$/.test(value)
        // IPv4: http://regexlib.com/REDetails.aspx?regexp_id=32
        || /^(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])$/.test(value)
        // IPv6: http://regexlib.com/REDetails.aspx?regexp_id=906 + allow lowercase hexa letters (a-f)
        || /^(^(([0-9A-Fa-f]{1,4}(((:[0-9A-Fa-f]{1,4}){5}::[0-9A-Fa-f]{1,4})|((:[0-9A-Fa-f]{1,4}){4}::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,1})|((:[0-9A-Fa-f]{1,4}){3}::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,2})|((:[0-9A-Fa-f]{1,4}){2}::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,3})|(:[0-9A-Fa-f]{1,4}::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,4})|(::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,5})|(:[0-9A-Fa-f]{1,4}){7}))$|^(::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,6})$)|^::$)|^((([0-9A-Fa-f]{1,4}(((:[0-9A-Fa-f]{1,4}){3}::([0-9A-Fa-f]{1,4}){1})|((:[0-9A-Fa-f]{1,4}){2}::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,1})|((:[0-9A-Fa-f]{1,4}){1}::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,2})|(::[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,3})|((:[0-9A-Fa-f]{1,4}){0,5})))|([:]{2}[0-9A-Fa-f]{1,4}(:[0-9A-Fa-f]{1,4}){0,4})):|::)((25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{0,2})\.){3}(25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{0,2})$$/.test(value);

    }, "<%= _("Enter a valid domain name or an IP address.") -%>");

    $(document).ready(function() {
      // make the error message translatable - override the default messsage
      $.extend($.validator.messages, {
	equalTo: "<%= _("The passwords do not match.") -%>"
      });
    });

    // start password validation workaround only when "Save" button has been pressed
    password_validation_enabled = false;
</script>

  <script type="text/javascript">
     $(document).ready(function(){
	$("#mailForm").validate()
     });
  </script>
<% end %>

<div class='plugin-icon'><img src='/icons/yast-mail-server.png'/><%=_("Mail Settings")%></div>

<div class='plugin-content grid_12'>

<% disabled = ! @permissions[:write] %>

  <% form_for(:mail_settings, @mail_settings, :url => { :action => "update" }, :html => { :method => :put, :id => "mailForm", :autocomplete => :off, :onsubmit => "if ($('#mailForm').valid()) $('#progress').show()" } ) do |f| %>
  <%= f.error_messages %>
    <fieldset class="grid_12">
      <p>
        <label for="<%= :smtp_server %>"><%=_("Outgoing mail server")%></label>
        <%=f.text_field :smtp_server, :disabled => disabled, :class => "smtp_server" %></p>
      <p>
        <label><%=_("Use secure connection (TLS)")%></label>
        <%= f.select :transport_layer_security, [ [_("Never"), "NONE" ], [_("If available"), "MAY"], [_("Always"), "MUST"]], :disabled => disabled %></p>
      <p>
        <label><%=_("User name")%></label>
        <%= f.text_field :user, :disabled => disabled %></p>
     </fieldset>
	<fieldset class="grid_12">
      <p>
        <label><%=_("Password")%></label>
        <%= f.password_field :password, :disabled => disabled, :onkeyup => "if (password_validation_enabled) $('#mailForm').validate().element('#mail_settings_confirm_password')" %></p>
      <p>
        <label><%=_("Confirm password")%></label>
        <%= f.password_field :confirm_password, :disabled => disabled, :equalTo => "#mail_settings_password" %>
      </p>
    </fieldset> 
	<fieldset class="grid_12" id="div1">
		<label><%=_("Password")%></label>
		<input name="pass_temp" type="text" value="Password for SMTP server login" size="20" maxlength="20" onfocus="changeBox()" />
	</fieldset>
	<fieldset class="grid_12" id="div2" style="display:none">
		<label><%=_("Password")%></label>
		<input name="password" id="password" type="password" value="" size="20" maxlength="20" onBlur="restoreBox()" />
	</fieldset>
	<fieldset class="grid_12" id="div1">
		<label><%=_("Confirm password")%></label>
		<input name="pass_temp" type="text" value="Retype password for SMTP server login" size="20" maxlength="20" onfocus="changeBox()" />
	</fieldset>
	<fieldset class="grid_12" id="div2" style="display:none">
		<label><%=_("Confirm password")%></label>
		<input name="password" id="password" type="password" value="" size="20" maxlength="20" onBlur="restoreBox()" />
	</fieldset>
    <p>
    <%= form_send_buttons :onclick=>"password_validation_enabled = true", :disabled => disabled %>
    </p>
  <% end %>
</div>

