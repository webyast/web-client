<%
  write_disabled = ! @permissions[:write]
  static_disabled = write_disabled || @conf_mode != "static"
%>
<% content_for :head do %>
   <%= javascript_include_tag :defaults %>
   <link rel="stylesheet" href="/inc/smoothness/jquery.ui.custom.css" type="text/css" media="screen" title="default" charset="utf-8" />

   <% javascript_tag do -%>
      function disable_static_config(abool) {
          $("#ip")[0].disabled = abool;
          $("#netmask")[0].disabled = abool;
          $("#nameservers")[0].disabled = abool;
          $("#searchdomains")[0].disabled = abool;
          $("#default_route")[0].disabled = abool;
// TODO fix and use this
//          $.each(["#ip", "#netmask",
//                  "#nameservers", "#searchdomains",
//                  "#default_route"], function() {
//              $(this)[0].disabled = abool;
//          });
      }
   <% end -%>
   <% javascript_tag do -%>
      function validIP(ip) {
        valid = ip.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/);
        return valid;
      }
      function validMask(ip) {
        return validIP(ip); // FIXME
      }
      function validPrefix(ip) {
        return false; //FIXME
      }

      function validateNetwork() {
        if ($("#conf_mode")[0].value == "static") {
          say_bad = "<%= _("Invalid IP address format. The correct one is nnn.nnn.nnn.nnn for nnn between 0 and 255.") %>"
          if (! validIP($("#ip")[0].value)) {
            $("#ip").focus();
            alert (say_bad);
            return false;
          }
          netmask = $("#netmask")[0].value;
          if (!validPrefix(netmask) && ! validMask(netmask)) {
            $("#netmask").focus();
            alert (say_bad);
            return false;
          }
          if (! validIP($("#default_route")[0].value)) {
            $("#default_route").focus();
            alert (say_bad);
            return false;
          }
        }
        $('#progress').show();
        return true;
      };
   <% end %>
<% end %>
<div class='plugin-icon'><img src='/icons/yast-network.png' alt=''/></div>
<h2><%=_("Network")%></h2>
<div class='plugin-content grid_12'>

<% form_tag("/network", :method => "get") do %>
  <!-- (collection, value, text, selected) -->


<!--  temporally disabled - 2009-10-26 rlihm
  <fieldset id="interface_set" class="">
    <legend><%= _("Interface")%></legend>
    <p>
      <%= select_tag(:interface, options_from_collection_for_select(@ifcs, :id, :id, @iface)) %>
    </p>
    <p>
      <%= submit_tag(_("Select"), :class => "button") %>
    </p>
  </fieldset>
   -->

<% end %>


<% form_for :network, @network, :url => { :action => "update" }, :html => { :method => :put, :onsubmit => "return validateNetwork();" , :class => 'tab-form'} do |n| %>
<%= n.error_messages %>
<!-- ~/svn/web-client/plugins/systemtime/app/views/systemtime/index.rhtml -->
  
  <ul class="tab-nav">
    <!-- javascript adds tabs here -->
  </ul>
  
  <input type="hidden" id="interface" name="interface" value="<%= @iface %>"/>

  <fieldset id="ip-address" class="">
    <legend><%=_("IP address")%></legend>
    <p>
      <label for="<%= :conf_mode %>"><%=_("Configuration mode")%></label>
      <%= select_tag(:conf_mode, options_for_select(@conf_modes, @conf_mode), :disabled => write_disabled)%>
    </p>
    <p>
      <label for="<%= :ip %>"><%=_("IP address")%></label>
      <%=text_field_tag :ip, @ip, :disabled => static_disabled %>
    </p>
    <p>
      <label for="<%= :netmask %>"><%=_("Prefixlen")%></label>
      <%=text_field_tag :netmask, @netmask, :disabled => static_disabled %>
    </p>
  </fieldset>
  <fieldset id="dns" class="">
    <legend><%=_("DNS")%></legend>
    <p>
      <label for="<%= :name %>"><%=_("Hostname")%></label>
      <%=text_field_tag :name, @name, :disabled => write_disabled %>
    </p>
    <p>
      <label for="<%= :domain %>"><%=_("Domain")%></label>
      <%=text_field_tag :domain, @domain, :disabled => write_disabled %>
    </p>
    <p>
      <label for="<%= :nameservers %>"><%=_("Name servers")%></label>
      <%=text_field_tag :nameservers, @nameservers.join(" "), :disabled => static_disabled %>
    </p>
    <p>
      <label for="<%= :searchdomains %>"><%=_("Search domains")%></label>
      <%=text_field_tag :searchdomains, @searchdomains.join(" "), :disabled => static_disabled %>
    </p>
  </fieldset>

  <fieldset id="routing" class="ui-tab">
    <legend><%=_("Routing")%></legend>
    <p>
      <label for="<%= :default_route %>"><%=_("Default route")%></label>
      <%=text_field_tag :default_route, @default_route, :disabled => static_disabled %>
    </p>
  </fieldset>
  <p>
    <%= form_send_buttons :disabled => write_disabled %>
  </p>
<% end %>
</div>

<% javascript_tag do -%>
   $('#conf_mode').delayedObserver(0.25, function(element, value) {
     disabled = <%= write_disabled %> || value != "static";
     disable_static_config(disabled);
   })
<% end -%>